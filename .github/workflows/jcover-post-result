#!/bin/bash

# stop executing after error
set -e 

REPO_FULLNAME=$(jq -r ".repository.full_name" "$GITHUB_EVENT_PATH")
git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/$REPO_FULLNAME.git
git config --global user.email "jcover@diffblue.com"
git config --global user.name "Diffblue JCover"

if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
    pr=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
    head=$(git symbolic-ref --short HEAD)
    echo "JCover PR mode, for PR ${pr}, against ${head}"
    # find the closest common ancestor between the PR branch and master
    common_ancestor_sha="$(git merge-base $GITHUB_SHA origin/master)"
    api_url="$(cat $GITHUB_EVENT_PATH | jq --raw-output '.pull_request.comments_url')"
    branch="${pr}"
    git branch -C "jcover-${branch}"
    git rm -r src/test
    mv src/jcover src/test
    git add src/test
    git commit -m "Unit tests generated by JCover" -a
    git push --force --set-upstream origin "jcover-${branch}"
    comment="JCover generated X tests for PR #${pr}. "
    comment="[View the diff](http://github.com/${GITHUB_REPOSITORY}/compare/master...jcover-${branch})."
else
    branch="${GITHUB_REF##*/}"
    echo "JCover commit mode, on branch ${branch}"
    common_ancestor_sha="$(git rev-parse HEAD^1)"
    api_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/comments"
    git checkout -B "jcover-${branch}"
    git rm -r src/test
    mv src/jcover src/test
    git add src/test
    git commit -m "Unit tests generated by JCover" -a
    git push --force --set-upstream origin "jcover-${branch}"
    comment="JCover generated X tests for branch ${branch}. "
    comment+="[View the diff](http://github.com/${GITHUB_REPOSITORY}/compare/${branch}...jcover-${branch})."
fi

# Post comment on Github

curl --include --silent --show-error --fail \
  -H "Accept: application/json" \
  -H "Content-Type: application/json" \
  -H "Authorization: token ${GITHUB_TOKEN}" \
  --request POST \
  --data "$(jq --null-input --arg escaped_comment "$comment" '{body: $escaped_comment}')" \
  $api_url

echo "Done"
